name: Deploy to cPanel

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy and Migrate
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨á Checkout Repository
      uses: actions/checkout@v3

    - name: üì¶ Deploy to FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: 192.250.229.30
        username: ftpgithub@safedatait.com
        password: fXIV}m2Ws&Z0ofbI

    - name: ‚è≥ Wait for files to sync
      run: sleep 20

    - name: üîß Test if API endpoint exists
      run: |
        echo "Testing if the API endpoint is accessible..."
        curl -X GET https://safedatait.com/api/deploy/migrate -I -L

    - name: üîß Run Migrations via HTTP
      run: |
        echo "Running migrations..."
        response=$(curl -X POST https://safedatait.com/api/deploy/migrate \
          -H "X-Deploy-Token: 7k9mP2vL8nQ4wR6xT3yU1zB5cD0eF7gH9jK2mN4pQ6sT8vW0xY3zA5bC7dE9fG1h" \
          -w "\n%{http_code}" \
          --max-time 300 \
          --retry 3 \
          --retry-delay 5 \
          -L \
          -s)
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')
        
        echo "Response Body: $body"
        echo "HTTP Code: $http_code"
        
        if [ "$http_code" = "200" ]; then
          echo "‚úÖ Migration completed successfully"
        else
          echo "‚ùå Migration failed with HTTP code $http_code"
          echo "Response: $body"
          exit 1
        fi

    - name: üéâ Deployment Complete
      run: echo "Deployment and migration completed successfully!"